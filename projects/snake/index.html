<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snake</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.4.1/gl-matrix-min.js"></script>
  <script src="input.js"></script>
  <script src="m.js"></script>
  <script src="g.js"></script>
  <script src="grid.js"></script>
  <script src="model.js"></script>
  <script src="view_line.js"></script>
  <script src="view_2d.js"></script>
  <script src="view_score.js"></script>
  <script src="gl_utils.js"></script>
  <script>
    "use strict";

    let canvas;
    let overlay;
    let model;
    let line_view;
    let view_2d;
    let gl;
    let SHADER_ATTRIB_POSITION;
    let SHADER_ATTRIB_COLOR;
    let SHADER_ATTRIB_NORMAL;
    let SHADER_UNIFORM_PROJECTION;
    let SHADER_UNIFORM_MODEL;
    let position_buffer;
    let color_buffer;
    let normal_buffer;

    let polledInput = null;
    function keyPressed(e) { polledInput.keyPressed(e);	}
    function keyReleased(e) { polledInput.keyReleased(e);	}

    function main() {
      // resize canvas (pixel size) to what it really is (css size)
      canvas = document.getElementById("c");
      canvas.width  = canvas.clientWidth;
      canvas.height = canvas.clientHeight;

      // put html overlay on top of canvas
      overlay = document.getElementById("overlay");
      overlay.style.top = '0px';
      overlay.style.left = (((window.innerWidth - canvas.width) / 2) - 23) + 'px'; // TODO why 23?
      overlay.style.width = canvas.width + 'px';
      overlay.style.height = canvas.height + 'px';

      // setup input
      polledInput = new PolledInput();
      document.onkeydown = keyPressed;
      document.onkeyup = keyReleased;

      // get graphics context
      gl = canvas.getContext("webgl2");
      if(!gl) return;
      gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

      // shader setup
      let vertexShaderSource = `#version 300 es
      uniform mat4 my_projection;
      uniform mat4 my_model;
      in vec3 my_position;
      in vec4 my_color;
      in vec3 my_normal;
      out vec4 x_color;
      out float x_theta;
      void main() {
        x_color = my_color;
        // hardcode light direction vector
        x_theta = dot(my_normal, vec3(.3,.9055,.3));
        gl_Position = my_projection * my_model * vec4(my_position, 1.0);
        gl_PointSize = 10.0;
      }
      `;
      let fragmentShaderSource = `#version 300 es
      precision mediump float;
      in vec4 x_color;
      in float x_theta;
      out vec4 frag_color;
      void main() {
        vec4 c = x_color;
        // keep half of the color as is, and diffuse the rest
        frag_color = (c * .50) + (c * max(x_theta, .1) * .50);
      }
      `;
      let vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource); if(!vertexShader) return;
      let fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource); if(!fragmentShader) return;
      let program = createProgram(gl, vertexShader, fragmentShader); if(!program) return;
      SHADER_ATTRIB_POSITION = gl.getAttribLocation(program, "my_position");
      SHADER_ATTRIB_COLOR = gl.getAttribLocation(program, "my_color");
      SHADER_ATTRIB_NORMAL = gl.getAttribLocation(program, "my_normal");
      SHADER_UNIFORM_PROJECTION = gl.getUniformLocation(program, "my_projection");
      SHADER_UNIFORM_MODEL = gl.getUniformLocation(program, "my_model");

      // settings
      gl.enable(gl.DEPTH_TEST);
      gl.depthFunc(gl.LESS);
      gl.enable(gl.CULL_FACE);
      gl.useProgram(program);

      // in webgl, we must use vertex buffers instead of passing the array as the offset of vertexAttribPointer
      position_buffer = gl.createBuffer();
      color_buffer = gl.createBuffer();
      normal_buffer = gl.createBuffer();

      // model
      let half_length = 600;
      model = new Model(half_length * 2);

      // views
      line_view = new LineView(model, half_length, gl);
      hud = new ScoreView(model);
      view_2d = new View2D(model, half_length, gl);

      // hook up listeners and reset model
      model.listeners.push(line_view);
      model.listeners.push(hud);
      model.listeners.push(view_2d);
      model.reset();

      // game loop speed
      setInterval(tick, 12);
    }

    let previous_ms = undefined;
    function tick() {
      // time
      let now_ms = performance.now();
      if(!previous_ms) previous_ms = now_ms;
      let delta_ms = now_ms - previous_ms;
      let delta_s = delta_ms / 1000.0;
      previous_ms = now_ms;
      // fps
      document.getElementById("fps").innerHTML = M.round_dx(1 / delta_s, 3);

      // input
      model.setInput(polledInput.held(VK_LEFT) || polledInput.held(VK_A), polledInput.held(VK_RIGHT) || polledInput.held(VK_D));
      polledInput.polled();

      // model
      //if(delta_s > .2) alert(" ms:" + delta_ms + " s:" + delta_s);
      model.tick(now_ms, delta_s);

      // scene
      gl.clearColor(.4, 0, .4, 1);
      gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

      // projection
      let eye = vec3.create();
      let center = vec3.create();
      let up = vec3.create();
      let look_at = mat4.create();
      let perspective = mat4.create();
      let projection = mat4.create();
      let identity = mat4.create();
      vec3.set(eye, 0, 0, .1);
      vec3.set(center, 0, 0, 0);
      vec3.set(up, 0, -1, 0);
      mat4.lookAt(look_at, eye, center, up);
      mat4.perspective(perspective, 60.0, gl.canvas.width / gl.canvas.height, 0.01, 100.0);
      mat4.mul(projection, perspective, look_at);
      gl.uniformMatrix4fv(SHADER_UNIFORM_PROJECTION, false, projection);
      gl.uniformMatrix4fv(SHADER_UNIFORM_MODEL, false, identity);

      // gfx views
      line_view.render();
      view_2d.render();

/*
      // position
      let positions = [
        0, 0, 0,
        Math.random(), 0, 0,
        0, 0.5, 0,
      ];
      gl.bindBuffer(gl.ARRAY_BUFFER, position_buffer);
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);
      gl.vertexAttribPointer(SHADER_ATTRIB_POSITION, 3, gl.FLOAT, false, 0, 0);
      gl.enableVertexAttribArray(SHADER_ATTRIB_POSITION);

      // color (as a constant)
      gl.vertexAttrib4f(SHADER_ATTRIB_COLOR, 0, 1, 0, 1);
      gl.disableVertexAttribArray(SHADER_ATTRIB_COLOR);
      // color (per vertex)
      /*
      let colors = [
        1, 0, 0, 1,
        0, 1, 0, 1,
        0, 0, 1, 1,
      ];
      gl.bindBuffer(gl.ARRAY_BUFFER, color_buffer);
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);
      gl.vertexAttribPointer(SHADER_ATTRIB_COLOR, 4, gl.FLOAT, false, 0, 0);
      gl.enableVertexAttribArray(SHADER_ATTRIB_COLOR);
      */
/*
      // normal
      let normals = [
        0, 0, 1,
        0, 0, 1,
        0, 0, 1,
      ];
      gl.bindBuffer(gl.ARRAY_BUFFER, normal_buffer);
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(normals), gl.STATIC_DRAW);
      gl.vertexAttribPointer(SHADER_ATTRIB_NORMAL, 3, gl.FLOAT, false, 0, 0);
      gl.enableVertexAttribArray(SHADER_ATTRIB_NORMAL);

      gl.drawArrays(gl.TRIANGLES, 0, 3);
*/
    }
  </script>
  <link rel="stylesheet" href="../../styles2018.css">
  <style>
    canvas {
      width: 80vw;
      height: 60vh;
      display: inline;
    }
    .container {
      position: relative;
    }
    #overlay {
      position: absolute;
      /* background-color: rgba(0, 0, 0, .7); */
      color: white;
      font-family: monospace;
      padding: 0em;
    }
    .v-center {
      position: relative;
      top: 50%;
      transform: translateY(-50%);
      padding: 2em;
    }
    #menu {
      visibility: hidden;
    }
  </style>
</head>
<body onload="main();">

<header>Snake<br/><time>2018-04</time></header>
<article>

<figure class="A">
  <div class="container">
    <canvas id="c"></canvas>
    <div id="overlay">
      <div id="menu" class="v-center" style="display: inline-block; background-color: rgba(255, 255, 255, .7);">
        <header>Snake<br/><time>2018-04</time></header>
        <button type="button">Click Me!</button><br/>
        <button type="button">Click Me!</button><br/>
        <button type="button">Click Me!</button><br/>
      </div>
      <div id="debug" class="v-center">
        <p align="left">FPS:<span id="fps"></span></p>
      </div>
      <div id="hud" class="v-center">
        <p align="left">Score: <span id="score"></span></p>
      </div>
    </div>
  </div>
  <figcaption>Snake (webgl2)</figcaption>
</figure>

</body>
</html>
